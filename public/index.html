<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Salt Index - Live Monitoring Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; padding: 20px; min-height: 100vh; }
    .container { max-width: 1400px; margin: 0 auto; }
    header { text-align: center; color: white; margin-bottom: 30px; }
    h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 10px; }
    .subtitle { font-size: 1.1rem; opacity: 0.9; }
    .health-bar { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .health-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
    .stat { text-align: center; }
    .stat-value { font-size: 2rem; font-weight: 700; color: #667eea; }
    .stat-label { font-size: 0.85rem; color: #666; margin-top: 5px; }
    .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    @media (max-width: 968px) { .dashboard-grid { grid-template-columns: 1fr; } }
    .sentiment-card, .sources-card, .batches-card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .batches-card { grid-column: 1 / -1; }
    .card-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 20px; color: #333; }
    .sentiment-gauge { position: relative; height: 200px; display: flex; align-items: center; justify-content: center; margin: 20px 0; }
    .gauge-bg { width: 180px; height: 180px; border-radius: 50%; background: conic-gradient(from 180deg, #ff4444 0deg, #ffaa00 90deg, #44ff44 180deg); display: flex; align-items: center; justify-content: center; }
    .gauge-inner { width: 140px; height: 140px; border-radius: 50%; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .sentiment-score { font-size: 3rem; font-weight: 700; line-height: 1; }
    .sentiment-label { font-size: 0.9rem; color: #666; margin-top: 5px; }
    .source-list { display: flex; flex-direction: column; gap: 12px; }
    .source-item { display: flex; align-items: center; padding: 15px; border-radius: 8px; background: #f8f9fa; border-left: 4px solid #ddd; transition: all 0.2s; position: relative; cursor: help; }
    .source-item:hover { transform: translateX(5px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .source-item.connected { border-left-color: #44ff44; }
    .source-item.not-connected { border-left-color: #ccc; opacity: 0.7; }
    .source-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-right: 15px; overflow: hidden; }
    .source-icon.telegram { background: #0088cc; }
    .source-icon.discord { background: #5865F2; }
    .source-icon.twitter { background: #ffffff; border: 1px solid #e1e8ed; }
    .source-icon img { width: 100%; height: 100%; object-fit: cover; }
    .source-info { flex: 1; }
    .source-name { font-weight: 600; font-size: 1rem; margin-bottom: 4px; }
    .source-target { font-size: 0.85rem; color: #666; }
    .source-stats { text-align: right; }
    .messages-count { font-weight: 700; font-size: 1.1rem; color: #667eea; }
    .last-message { font-size: 0.75rem; color: #999; margin-top: 2px; }
    .status-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
    .status-badge.connected { background: #d4edda; color: #155724; }
    .status-badge.not-connected { background: #e2e3e5; color: #6c757d; }
    .tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s; margin-bottom: 5px; }
    .source-item:hover .tooltip { opacity: 1; }
    .batch-list { display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto; }
    .batch-item { display: flex; align-items: center; padding: 12px; border-radius: 6px; background: #f8f9fa; font-size: 0.9rem; }
    .batch-time { color: #666; margin-right: 15px; min-width: 100px; }
    .batch-info { flex: 1; }
    .batch-status { width: 8px; height: 8px; border-radius: 50%; margin-left: 10px; }
    .batch-status.success { background: #44ff44; }
    .batch-status.failed { background: #ff4444; }
    .loading { text-align: center; padding: 40px; color: white; font-size: 1.2rem; }
    .refresh-indicator { position: fixed; bottom: 20px; right: 20px; background: rgba(255,255,255,0.95); padding: 10px 20px; border-radius: 20px; font-size: 0.85rem; color: #666; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .refresh-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #44ff44; margin-right: 8px; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab { background: rgba(255,255,255,0.2); color: white; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; border: 2px solid transparent; }
    .tab:hover { background: rgba(255,255,255,0.3); }
    .tab.active { background: white; color: #667eea; border-color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .api-routes { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .route-group { margin-bottom: 30px; }
    .route-group-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 15px; color: #667eea; }
    .route-item { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #667eea; }
    .route-method { display: inline-block; padding: 4px 8px; border-radius: 4px; font-weight: 700; font-size: 0.75rem; margin-right: 10px; color: white; }
    .route-method.get { background: #28a745; }
    .route-method.post { background: #007bff; }
    .route-method.put { background: #ffc107; color: #333; }
    .route-method.delete { background: #dc3545; }
    .route-path { font-family: 'Courier New', monospace; font-weight: 600; color: #333; }
    .route-desc { margin-top: 8px; color: #666; font-size: 0.9rem; }
    .auth-banner { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .auth-input-group { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; }
    .auth-input { flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.9rem; font-family: 'Courier New', monospace; }
    .auth-input:focus { outline: none; border-color: #667eea; }
    .auth-button { padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .auth-button:hover { background: #5568d3; }
    .auth-button.logout { background: #dc3545; }
    .auth-button.logout:hover { background: #c82333; }
    .auth-status { padding: 12px; border-radius: 8px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
    .auth-status.admin { background: #d4edda; color: #155724; }
    .auth-status.view { background: #d1ecf1; color: #0c5460; }
    .delete-btn { padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: all 0.2s; }
    .delete-btn:hover { background: #c82333; transform: scale(1.05); }
    .delete-btn:disabled { background: #ccc; cursor: not-allowed; opacity: 0.6; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background: white; border-radius: 12px; padding: 30px; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    .modal-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 15px; color: #dc3545; }
    .modal-body { margin-bottom: 20px; color: #333; line-height: 1.6; }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
    .modal-btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .modal-btn.cancel { background: #e0e0e0; color: #333; }
    .modal-btn.cancel:hover { background: #d0d0d0; }
    .modal-btn.confirm { background: #dc3545; color: white; }
    .modal-btn.confirm:hover { background: #c82333; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üßÇ Salt Index</h1>
      <p class="subtitle">Real-time Sentiment Analysis Dashboard</p>
    </header>

    <div class="auth-banner" id="auth-banner">
      <div id="auth-input-section">
        <div class="auth-input-group">
          <input type="password" id="api-key-input" class="auth-input" placeholder="Enter API Key (Admin or View)">
          <button class="auth-button" onclick="authenticate()">Authenticate</button>
        </div>
        <p style="color: #666; font-size: 0.85rem; margin: 0;">Enter your API key to access the dashboard. Admin keys enable delete controls.</p>
      </div>
      <div id="auth-status-section" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div class="auth-status" id="auth-status"></div>
          <button class="auth-button logout" onclick="logout()">Logout</button>
        </div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</div>
      <div class="tab" onclick="switchTab('api')">üîå API Routes</div>
    </div>
    <div id="dashboard-tab" class="tab-content active">
      <div id="dashboard"><div class="loading">Loading dashboard...</div></div>
    </div>
    <div id="api-tab" class="tab-content">
      <div class="api-routes">
        <h2 style="margin-bottom: 20px; color: #333;">Available API Endpoints</h2>

        <div class="route-group">
          <div class="route-group-title">System</div>
          <div class="route-item">
            <span class="route-method get">GET</span>
            <span class="route-path">/api/health</span>
            <div class="route-desc">Health check endpoint - returns system status and version</div>
          </div>
          <div class="route-item">
            <span class="route-method get">GET</span>
            <span class="route-path">/api/dashboard</span>
            <div class="route-desc">Get complete dashboard data including sentiment, sources, and recent batches</div>
          </div>
        </div>

        <div class="route-group">
          <div class="route-group-title">Trackers</div>
          <div class="route-item">
            <span class="route-method get">GET</span>
            <span class="route-path">/api/trackers</span>
            <div class="route-desc">List all configured trackers</div>
          </div>
          <div class="route-item">
            <span class="route-method get">GET</span>
            <span class="route-path">/api/trackers/:id</span>
            <div class="route-desc">Get detailed information about a specific tracker</div>
          </div>
          <div class="route-item">
            <span class="route-method get">GET</span>
            <span class="route-path">/api/trackers/:id/snapshot</span>
            <div class="route-desc">Get current snapshot for tracker (latest sentiment data)</div>
          </div>
          <div class="route-item">
            <span class="route-method get">GET</span>
            <span class="route-path">/api/trackers/:id/timeseries</span>
            <div class="route-desc">Get time-series data for tracker (requires bucket and from params)</div>
          </div>
          <div class="route-item">
            <span class="route-method delete">DELETE</span>
            <span class="route-path">/api/trackers/:id/statistics</span>
            <div class="route-desc">üîí Delete all statistics for tracker (admin only)</div>
          </div>
          <div class="route-item">
            <span class="route-method delete">DELETE</span>
            <span class="route-path">/api/trackers/:id/statistics/:bucket</span>
            <div class="route-desc">üîí Delete statistics for specific time bucket (admin only)</div>
          </div>
        </div>

        <div class="route-group">
          <div class="route-group-title">Sources</div>
          <div class="route-item">
            <span class="route-method get">GET</span>
            <span class="route-path">/api/sources</span>
            <div class="route-desc">List all configured sources (Telegram, Discord, Twitter)</div>
          </div>
          <div class="route-item">
            <span class="route-method get">GET</span>
            <span class="route-path">/api/sources/:id</span>
            <div class="route-desc">Get detailed information about a specific source</div>
          </div>
          <div class="route-item">
            <span class="route-method get">GET</span>
            <span class="route-path">/api/sources/:id/snapshot</span>
            <div class="route-desc">Get current snapshot for source (latest sentiment data)</div>
          </div>
          <div class="route-item">
            <span class="route-method delete">DELETE</span>
            <span class="route-path">/api/sources/:id/statistics</span>
            <div class="route-desc">üîí Delete all statistics for source (admin only)</div>
          </div>
        </div>

        <div class="route-group">
          <div class="route-group-title">Users</div>
          <div class="route-item">
            <span class="route-method get">GET</span>
            <span class="route-path">/api/users</span>
            <div class="route-desc">List users with filtering by platform, tracker, messages, sentiment, or tags</div>
          </div>
          <div class="route-item">
            <span class="route-method get">GET</span>
            <span class="route-path">/api/users/:id</span>
            <div class="route-desc">Get detailed information about a specific user</div>
          </div>
          <div class="route-item">
            <span class="route-method get">GET</span>
            <span class="route-path">/api/users/:id/sentiment-history</span>
            <div class="route-desc">Get sentiment history for a user across trackers</div>
          </div>
          <div class="route-item">
            <span class="route-method get">GET</span>
            <span class="route-path">/api/users/top/active</span>
            <div class="route-desc">Get most active users (by message count)</div>
          </div>
        </div>

        <div class="route-group">
          <div class="route-group-title">Admin üîí</div>
          <div class="route-item">
            <span class="route-method get">GET</span>
            <span class="route-path">/api/admin/stats</span>
            <div class="route-desc">Get system statistics (database size, memory, queue depth)</div>
          </div>
          <div class="route-item">
            <span class="route-method post">POST</span>
            <span class="route-path">/api/admin/reload-config</span>
            <div class="route-desc">Reload configuration from config.toml without restart</div>
          </div>
          <div class="route-item">
            <span class="route-method post">POST</span>
            <span class="route-path">/api/admin/cleanup</span>
            <div class="route-desc">Run cleanup tasks (debug_traces, old_batches, or all)</div>
          </div>
        </div>

        <div style="margin-top: 30px; padding: 20px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
          <strong>üîí Authentication Required:</strong><br>
          Most endpoints require API authentication. Include your API key in requests:<br>
          <code style="display: block; margin-top: 8px; padding: 8px; background: white; border-radius: 4px;">
            curl -H "Authorization: Bearer YOUR_API_KEY" <span id="example-url"></span>/api/trackers
          </code>
          <div style="margin-top: 10px; font-size: 0.9rem;">
            Admin endpoints (üîí) require the admin API key from .env file<br>
            View-only keys can only access GET endpoints
          </div>
        </div>

        <div style="margin-top: 20px; padding: 20px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #007bff;">
          <strong>Base URL:</strong> <code id="base-url"></code><br>
          <strong>Response Format:</strong> JSON<br>
          <strong>Public Endpoints:</strong> /api/health (no auth required)
        </div>
      </div>
    </div>
    <div class="refresh-indicator"><span class="refresh-dot"></span><span id="refresh-text">Live</span></div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="modal">
    <div class="modal-content">
      <div class="modal-title">‚ö†Ô∏è Confirm Deletion</div>
      <div class="modal-body" id="modal-body"></div>
      <div class="modal-actions">
        <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
        <button class="modal-btn confirm" id="modal-confirm-btn">Delete</button>
      </div>
    </div>
  </div>

  <script>
    let refreshInterval, lastUpdate = null;
    let userPermission = null; // 'admin' or 'view'
    const platformIcons = {
      telegram: '/images/telegram.svg',
      discord: '/images/discord.jpg',
      twitter: '/images/twitter.svg'
    };
    const platformIconFallback = { telegram: '‚úàÔ∏è', discord: 'üí¨', twitter: 'üê¶' };
    const platformNames = { telegram: 'Telegram', discord: 'Discord', twitter: 'Twitter / X' };

    // Authentication functions
    async function authenticate() {
      const apiKey = document.getElementById('api-key-input').value.trim();
      if (!apiKey) {
        alert('Please enter an API key');
        return;
      }

      try {
        const response = await fetch('/api/dashboard', {
          headers: { 'Authorization': `Bearer ${apiKey}` }
        });

        if (response.status === 401) {
          alert('Invalid API key');
          return;
        }

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        // Store API key and detect permission level
        sessionStorage.setItem('apiKey', apiKey);

        // Test admin endpoint to determine permission level
        const adminTest = await fetch('/api/admin/stats', {
          headers: { 'Authorization': `Bearer ${apiKey}` }
        });

        userPermission = adminTest.ok ? 'admin' : 'view';

        // Update UI
        document.getElementById('auth-input-section').style.display = 'none';
        document.getElementById('auth-status-section').style.display = 'block';
        const statusEl = document.getElementById('auth-status');
        statusEl.className = `auth-status ${userPermission}`;
        statusEl.innerHTML = userPermission === 'admin'
          ? 'üîë Admin Access - Full Controls'
          : 'üëÅÔ∏è View Access - Read Only';

        // Start dashboard refresh
        fetchDashboard();
        startRefresh();
      } catch (error) {
        console.error('Auth error:', error);
        alert('Failed to authenticate. Please check your API key.');
      }
    }

    function logout() {
      sessionStorage.removeItem('apiKey');
      userPermission = null;
      document.getElementById('auth-input-section').style.display = 'block';
      document.getElementById('auth-status-section').style.display = 'none';
      document.getElementById('api-key-input').value = '';
      document.getElementById('dashboard').innerHTML = '<div class="loading">Enter API key to view dashboard</div>';
      stopRefresh();
    }

    function getAuthHeaders() {
      const apiKey = sessionStorage.getItem('apiKey');
      return apiKey ? { 'Authorization': `Bearer ${apiKey}` } : {};
    }

    // Check for existing session on load
    window.addEventListener('DOMContentLoaded', () => {
      // Populate dynamic URLs
      const baseUrl = window.location.origin;
      document.getElementById('example-url').textContent = baseUrl;
      document.getElementById('base-url').textContent = baseUrl;

      const apiKey = sessionStorage.getItem('apiKey');
      if (apiKey) {
        document.getElementById('api-key-input').value = apiKey;
        authenticate();
      }
    });

    async function fetchDashboard() {
      try {
        const response = await fetch('/api/dashboard', {
          headers: getAuthHeaders()
        });

        if (response.status === 401) {
          logout();
          alert('Session expired. Please login again.');
          return;
        }

        const data = await response.json();
        renderDashboard(data);
        lastUpdate = new Date();
        updateRefreshText();
      } catch (error) {
        console.error('Failed to fetch dashboard:', error);
        document.getElementById('dashboard').innerHTML = '<div class="loading" style="color: #ff4444;">‚ö†Ô∏è Failed to load dashboard. Retrying...</div>';
      }
    }

    function renderDashboard(data) {
      const sentiment = data.sentiment || { score: 0, message_count: 0 };
      const sentimentColor = getSentimentColor(sentiment.score);
      const sentimentLabel = getSentimentLabel(sentiment.score);
      const queue = data.queue || { total_queued: 0, processing: false, estimated_batches: 0 };
      const queueColor = queue.processing ? '#ffaa00' : (queue.total_queued > 0 ? '#667eea' : '#44ff44');
      const queueStatus = queue.processing ? '‚öôÔ∏è' : (queue.total_queued > 0 ? '‚è≥' : '‚úì');

      document.getElementById('dashboard').innerHTML = `
        <div class="health-bar">
          <div class="health-stats">
            <div class="stat"><div class="stat-value">${data.system.total_platforms}</div><div class="stat-label">Total Platforms</div></div>
            <div class="stat"><div class="stat-value" style="color: #44ff44">${data.system.connected}</div><div class="stat-label">Connected</div></div>
            <div class="stat"><div class="stat-value" style="color: #aaa">${data.system.not_connected}</div><div class="stat-label">Not Connected</div></div>
            <div class="stat"><div class="stat-value">${data.system.messages_today}</div><div class="stat-label">Messages Today</div></div>
            <div class="stat"><div class="stat-value" style="color: ${queueColor}">${queueStatus} ${queue.total_queued}</div><div class="stat-label">Queue Depth</div></div>
          </div>
        </div>
        <div class="dashboard-grid">
          <div class="sentiment-card">
            <div class="card-title">üìä Current Sentiment</div>
            <div class="sentiment-gauge"><div class="gauge-bg"><div class="gauge-inner">
              <div class="sentiment-score" style="color: ${sentimentColor}">${sentiment.score >= 0 ? '+' : ''}${sentiment.score}</div>
              <div class="sentiment-label">${sentimentLabel}</div>
            </div></div></div>
            ${sentiment.message_count > 0 ? `
              <div style="text-align: center; color: #666; font-size: 0.9rem;">
                Based on ${sentiment.message_count} messages from ${sentiment.author_count} authors
              </div>
              <div style="text-align: center; color: #999; font-size: 0.85rem; margin-top: 5px;">
                Last updated: ${getRelativeTime(sentiment.timestamp)}
              </div>
            ` : '<div style="text-align: center; color: #999; font-size: 0.9rem;">No data yet - waiting for messages...</div>'}
          </div>
          <div class="sources-card">
            <div class="card-title">üîå Platform Sources</div>
            <div class="source-list">${renderSources(data.sources)}</div>
          </div>
        </div>
        <div class="batches-card">
          <div class="card-title">‚ö° Recent Processing Activity</div>
          <div class="batch-list">${renderBatches(data.recent_batches)}</div>
        </div>
        ${queue && queue.total_queued > 0 ? `
        <div class="batches-card" style="margin-top: 20px;">
          <div class="card-title">üì• Queue Status</div>
          <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <div style="display: flex; gap: 30px; flex-wrap: wrap;">
              <div><strong>Total Queued:</strong> ${queue.total_queued} messages</div>
              <div><strong>Estimated Batches:</strong> ${queue.estimated_batches}</div>
              <div><strong>Status:</strong> ${queue.processing ? 'üîÑ Processing...' : '‚è∏Ô∏è Waiting'}</div>
            </div>
            ${queue.by_tracker && Object.keys(queue.by_tracker).length > 0 ? `
              <div style="margin-top: 15px;">
                <strong>By Tracker:</strong>
                <div style="margin-top: 8px; display: flex; gap: 15px; flex-wrap: wrap;">
                  ${Object.entries(queue.by_tracker).map(([tracker, count]) =>
                    `<span style="padding: 4px 12px; background: white; border-radius: 12px; font-size: 0.9rem;">
                      ${tracker}: ${count}
                    </span>`
                  ).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        </div>
        ` : ''}
      `;
    }

    function renderSources(sources) {
      if (!sources || sources.length === 0) return '<div style="text-align: center; color: #999; padding: 20px;">No platforms available</div>';
      return sources.map(source => {
        const iconPath = platformIcons[source.platform];
        const fallbackIcon = platformIconFallback[source.platform] || 'üì°';
        const platformName = platformNames[source.platform] || source.platform;
        const statusClass = source.connected ? 'connected' : 'not-connected';
        const statusText = source.connected ? 'Connected' : 'Not Connected';
        const displayName = source.target || platformName;
        const tooltip = !source.connected && source.configured === false ?
          'Configure in config.toml to enable' : '';

        // Use img tag with fallback to emoji if image doesn't load
        const iconHtml = iconPath
          ? `<img src="${iconPath}" alt="${platformName}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" style="display:block;"><span style="display:none;">${fallbackIcon}</span>`
          : fallbackIcon;

        const deleteBtn = userPermission === 'admin'
          ? `<button class="delete-btn" onclick="confirmDeleteSource('${source.id}', '${displayName}')" title="Delete statistics for this source">üóëÔ∏è Delete Stats</button>`
          : '';

        return `<div class="source-item ${statusClass}">
          ${tooltip ? `<div class="tooltip">${tooltip}</div>` : ''}
          <div class="source-icon ${source.platform}">${iconHtml}</div>
          <div class="source-info">
            <div class="source-name">${displayName}</div>
            <div class="source-target"><span class="status-badge ${statusClass}">${statusText}</span></div>
          </div>
          <div class="source-stats">
            <div class="messages-count">${source.messages_today || 0}</div>
            <div class="last-message">Today</div>
            ${deleteBtn}
          </div>
        </div>`;
      }).join('');
    }

    function renderBatches(batches) {
      if (!batches || batches.length === 0) return '<div style="text-align: center; color: #999; padding: 20px;">No batches processed yet</div>';
      return batches.map(batch => {
        const time = new Date(batch.processed_at).toLocaleTimeString('en-US', { hour12: false });
        const statusClass = batch.success ? 'success' : 'failed';
        return `<div class="batch-item"><div class="batch-time">${time}</div><div class="batch-info">Processed ${batch.message_count} messages in ${batch.processing_time_ms}ms</div><div class="batch-status ${statusClass}"></div></div>`;
      }).join('');
    }

    function getSentimentColor(score) {
      if (score >= 50) return '#44ff44';
      if (score >= 20) return '#88ff44';
      if (score >= -20) return '#ffaa00';
      if (score >= -50) return '#ff8844';
      return '#ff4444';
    }

    function getSentimentLabel(score) {
      if (score >= 70) return 'Very Positive';
      if (score >= 30) return 'Positive';
      if (score >= -30) return 'Neutral';
      if (score >= -70) return 'Negative';
      return 'Very Negative';
    }

    function getRelativeTime(timestamp) {
      if (!timestamp) return '';
      const now = new Date();
      const then = new Date(timestamp);
      const seconds = Math.floor((now - then) / 1000);

      if (seconds < 10) return 'just now';
      if (seconds < 60) return `${seconds}s ago`;

      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;

      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;

      const days = Math.floor(hours / 24);
      return `${days}d ago`;
    }

    function updateRefreshText() {
      if (lastUpdate) {
        const seconds = Math.floor((new Date() - lastUpdate) / 1000);
        document.getElementById('refresh-text').textContent = seconds === 0 ? 'Just updated' : `Updated ${seconds}s ago`;
      }
    }

    function switchTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));

      // Show selected tab
      if (tabName === 'dashboard') {
        document.getElementById('dashboard-tab').classList.add('active');
        document.querySelectorAll('.tab')[0].classList.add('active');
      } else if (tabName === 'api') {
        document.getElementById('api-tab').classList.add('active');
        document.querySelectorAll('.tab')[1].classList.add('active');
      }
    }

    // Delete confirmation and execution functions
    function confirmDeleteSource(sourceId, sourceName) {
      document.getElementById('modal-body').innerHTML = `
        <p>Are you sure you want to delete all statistics for <strong>${sourceName}</strong>?</p>
        <p style="color: #dc3545; margin-top: 10px;">‚ö†Ô∏è This action cannot be undone. All aggregated data for this source will be permanently deleted.</p>
      `;
      document.getElementById('modal-confirm-btn').onclick = () => deleteSourceStats(sourceId);
      document.getElementById('delete-modal').classList.add('show');
    }

    async function deleteSourceStats(sourceId) {
      try {
        const response = await fetch(`/api/sources/${sourceId}/statistics`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const result = await response.json();
        const deletedCount = result.deleted?.source_aggregates || 0;
        alert(`‚úÖ Deleted ${deletedCount} statistics records for ${sourceId}`);
        closeModal();
        fetchDashboard(); // Refresh
      } catch (error) {
        console.error('Delete error:', error);
        alert('Failed to delete statistics. Check console for details.');
      }
    }

    function closeModal() {
      document.getElementById('delete-modal').classList.remove('show');
    }

    function startRefresh() {
      stopRefresh();
      refreshInterval = setInterval(fetchDashboard, 5000);
      setInterval(updateRefreshText, 1000);
    }

    function stopRefresh() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
      }
    }

    // Don't auto-start - wait for authentication
    setInterval(updateRefreshText, 1000);
  </script>
</body>
</html>
